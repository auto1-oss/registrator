version: 2
jobs:
  build:
    machine: true
    steps:
      - checkout
      - run:
          command: make circleci
      - run:
          name: Build
          command: make build
      - store_artifacts:
          path: build
      - deploy:
          name: Deploy website
          command: |
            if [[ "$CIRCLE_BRANCH" == "master" ]]; then
              mv .dockerignore .dockerignore-repo
              ssh-keygen -R github.com
              eval $(docker run gliderlabs/pagebuilder circleci-cmd)
              mv .dockerignore-repo .dockerignore
            fi
      - deploy:
          name: Deploy beta channel
          command: |
            if [[ "$CIRCLE_BRANCH" == "release" ]]; then
              make release
            fi
